import OpenAI from "openai"
import {asyncHandler} from '../utils/AsyncHandler.js'
import {ApiResponse } from '../utils/ApiResponse.js'
import {ApiError} from '../utils/ApiError.js'

const openAI=new OpenAI({
    apiKey:process.env.OPENAI_API_KEY

});


//controller to generate recipe by Ai
const generateRecipeByAi=asyncHandler(async(req,res)=>{

    const {ingredients,diet}=req.body;
if(!ingredients ){
    throw new ApiError(400,"mising ingredients and diet")
}
//user give prompt to model 
const prompt=` generate 3 simple recipe using this ingredient :${ingredients} 
and the diet ${diet} 
give title,ingredients,time,steps ,calories,proteins ,carbs
`;

const response=await openAI.chat.completions.create({
    model:"gpt-4o-mini",
    messages:[{
        role:"user",
        content:prompt
    }]
})

return res.status(200)
.json(new ApiResponse(200,response.choices[0].message.content,"recipe generated by Ai"))

});
const ingredientsdetector=asyncHandler(async(req,res)=>{
    const file=req.file;
    if(! file){
        throw new ApiError(400,"missing image file")
    }

    const image=req.file.buffer.toString("base64");

    const response=await openAI.chat.completions.create({
        model:"gpt-4o-mini",
        messages:[{
            role:"user",
            content:[
                {type:"text",text:"ingredients list"},
                {type:"image_url",image_url:{
                    url:`data:image/jpeg;base64,${image}`
                }}
            ]

        }],
    });
        
        return res.status(200)
        .json(new ApiResponse(200,response.choices[0].message.content,"ingredients found "))
         
                
})

export {
    generateRecipeByAi,
    ingredientsdetector

}